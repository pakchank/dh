#
# This is a Shiny web application. You can run the application by clicking
# the 'Run App' button above.
#
# Find out more about building applications with Shiny here:
#
#    https://shiny.posit.co/
#

library(shiny)
library(bslib)
library(tidyverse)
library(tidygraph)
library(igraph)
library(networkD3)



#dt_ner <- readRDS("dt_ner.rds")
gTidy <- readRDS("../gTidy.rds")
nodeAttr <- readRDS("../nodeAttr.rds")
dupList <- readRDS("../dupList.rds")

forceN <- function(thres) {
    gig <- gTidy |> 
        activate(edges) |>
        filter(weight > thres) |>
        activate(nodes) |> 
        left_join(nodeAttr |>
                      filter(!(text %in% dupList)), by=c("name"="text")) |>
        mutate(degree = centrality_degree()) |>
        filter(degree != 0) |>
        as.igraph() 
    gD3 <- gig |>
        igraph_to_networkD3(group=vertex_attr(gig)$cat)
    
    out <- forceNetwork(Links=gD3$links, Nodes=gD3$nodes,
                        Source = 'source', Target = 'target', NodeID = 'name', Group = 'group',
                        zoom=TRUE,
                        # layout
                        linkDistance = 250,                                                 # link size, if higher, more space between nodes
                        charge = -50,                                                       # if highly negative, more space betqeen nodes
                        
    )
    
    return(out)
}


# location algorithm은 바꿀 수 있을지...
# zoom도 필요.
# hosting한 후, iframe으로 넣기...
# 참고자료 알려주기.

# Define UI for application that draws a histogram
ui <- fillPage(
    page_sidebar(
        title = "KODDAS DB 네트워크 시각화",
        sidebar = sidebar( sliderInput("thres",
                                       "Number of bins:",
                                       min = 3,
                                       max = 10,
                                       value = 5)),
        forceNetworkOutput("distPlot")
    )
)

# Define server logic required to draw a histogram
server <- function(input, output) {

    output$distPlot <- renderForceNetwork({
        # forceNetwork(Links=gD3$links, Nodes=gD3$nodes,
        #              Source = 'source', Target = 'target', NodeID = 'name', Group = 'group',
        #              zoom=TRUE,
        #              # layout
        #              linkDistance = 250,                                                 # link size, if higher, more space between nodes
        #              charge = -50,                                                       # if highly negative, more space betqeen nodes
        #              
        # )
        forceN(input$thres)
            })
}

# Run the application 
shinyApp(ui = ui, server = server)
